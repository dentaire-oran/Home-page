<!DOCTYPE html>
<html lang="fr" data-theme="dark" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dental Guide Expert</title>
  
  <script src="https://unpkg.com/@phosphor-icons/web@2.1.2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    :root { --transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    [data-theme="dark"] { --bg: #0f172a; --glass: rgba(30, 41, 59, 0.7); --border: rgba(255,255,255,0.1); --text: #f8fafc; --primary: #6366f1; }
    [data-theme="light"] { --bg: #f1f5f9; --glass: rgba(255, 255, 255, 0.8); --border: rgba(0,0,0,0.1); --text: #1e293b; --primary: #4f46e5; }
    
    body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; transition: background var(--transition); overflow-x: hidden; }
    .glass { background: var(--glass); backdrop-filter: blur(12px); border: 1px solid var(--border); }
    
    #sidebar { 
        position: fixed; top: 0; bottom: 0; width: 280px; z-index: 100;
        transition: transform var(--transition); background: var(--glass);
    }
    html[dir="ltr"] #sidebar { left: 0; transform: translateX(-100%); border-right: 1px solid var(--border); }
    html[dir="rtl"] #sidebar { right: 0; transform: translateX(100%); border-left: 1px solid var(--border); }
    #sidebar.open { transform: translateX(0) !important; }

    .calc-input { width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--border); padding: 10px; border-radius: 10px; color: inherit; outline: none; }
    .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; cursor: pointer; transition: 0.2s; }
    .nav-link:hover { background: rgba(99, 102, 241, 0.1); }
    .active { background: var(--primary) !important; color: white; }
    
    .hidden-force { display: none !important; }
    .modal-overlay { position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; padding: 20px; }
  </style>
</head>
<body>

  <div id="authOverlay" class="fixed inset-0 z-[300] bg-[#0f172a] flex items-center justify-center p-6">
    <div class="glass p-8 rounded-3xl w-full max-w-sm shadow-2xl">
        <h2 class="text-3xl font-bold text-center mb-8 text-indigo-400">Dental Guide</h2>
        <div id="authStep1" class="space-y-4">
            <input type="text" id="id-nom" placeholder="Nom" class="calc-input">
            <input type="text" id="id-prenom" placeholder="PrÃ©nom" class="calc-input">
            <input type="text" id="id-dob" placeholder="JJ/MM/AAAA" class="calc-input" maxlength="10" oninput="formatDate(this)">
            <button onclick="goToStep2()" class="w-full bg-indigo-600 p-3 rounded-xl font-bold">Suivant</button>
        </div>
        <div id="authStep2" class="hidden-force space-y-4">
            <input type="password" id="auth-pass" placeholder="Mot de passe" class="calc-input">
            <button onclick="performAuth()" class="w-full bg-indigo-600 p-3 rounded-xl font-bold">Se connecter / S'inscrire</button>
            <button onclick="backToStep1()" class="w-full text-xs opacity-50">Retour</button>
        </div>
    </div>
  </div>

  <aside id="sidebar">
    <div class="p-6 flex flex-col h-full">
        <div class="text-2xl font-bold mb-10 text-indigo-500 flex items-center gap-2">
            <i class="ph-fill ph-tooth"></i> Expert 3.0
        </div>
        <nav class="space-y-2 flex-1">
            <div onclick="location.reload()" class="nav-link active"><i class="ph-bold ph-house"></i> Accueil</div>
            <div onclick="openModal('profileModal')" class="nav-link"><i class="ph-bold ph-user-circle"></i> Mon Profil</div>
            <div onclick="openModal('passModal')" class="nav-link"><i class="ph-bold ph-lock-key"></i> Mot de passe</div>
            <div class="h-px bg-white/10 my-4"></div>
            <div id="themeBtn" class="nav-link"><i class="ph-bold ph-palette"></i> Changer ThÃ¨me</div>
            <div onclick="setLang('fr')" class="nav-link">ðŸ‡«ðŸ‡· FranÃ§ais</div>
            <div onclick="setLang('ar')" class="nav-link">ðŸ‡©ðŸ‡¿ Arabe</div>
        </nav>
        <button onclick="logout()" class="nav-link text-red-400 mt-auto"><i class="ph-bold ph-sign-out"></i> DÃ©connexion</button>
    </div>
  </aside>

  <header class="lg:hidden fixed top-0 w-full p-4 glass z-50 flex justify-between items-center">
      <button onclick="toggleMenu()"><i class="ph-bold ph-list text-2xl"></i></button>
      <span class="font-bold">DENTAL GUIDE</span>
      <button onclick="openModal('profileModal')"><i class="ph-bold ph-user text-2xl"></i></button>
  </header>

  <main class="pt-24 lg:pt-10 lg:ml-[280px] p-6 max-w-5xl mx-auto">
    <h1 class="text-4xl font-black mb-8">Simulateur 3Ã¨me AnnÃ©e</h1>
    <div id="formContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    <div id="resultat" class="mt-10 mb-32"></div>
  </main>

  <div id="profileModal" class="modal-overlay hidden-force">
      <div class="glass p-8 rounded-3xl w-full max-w-md">
          <h3 class="text-xl font-bold mb-6">Modifier l'identitÃ©</h3>
          <div class="space-y-4">
              <input type="text" id="edit-nom" placeholder="Nom" class="calc-input">
              <input type="text" id="edit-prenom" placeholder="PrÃ©nom" class="calc-input">
              <input type="text" id="edit-dob" placeholder="JJ/MM/AAAA" class="calc-input" maxlength="10" oninput="formatDate(this)">
              <div class="flex gap-2">
                  <button onclick="updateProfile()" class="flex-1 bg-indigo-600 p-3 rounded-xl font-bold">Enregistrer</button>
                  <button onclick="closeModals()" class="flex-1 bg-white/10 p-3 rounded-xl">Fermer</button>
              </div>
          </div>
      </div>
  </div>

  <div id="passModal" class="modal-overlay hidden-force">
    <div class="glass p-8 rounded-3xl w-full max-w-md">
        <h3 class="text-xl font-bold mb-6">SÃ©curitÃ©</h3>
        <div class="space-y-4">
            <input type="password" id="old-pass" placeholder="Ancien mot de passe" class="calc-input">
            <input type="password" id="new-pass" placeholder="Nouveau mot de passe" class="calc-input">
            <input type="password" id="confirm-pass" placeholder="Confirmer le nouveau" class="calc-input">
            <div class="flex gap-2">
                <button onclick="changePassword()" class="flex-1 bg-indigo-600 p-3 rounded-xl font-bold">Modifier</button>
                <button onclick="closeModals()" class="flex-1 bg-white/10 p-3 rounded-xl">Annuler</button>
            </div>
        </div>
    </div>
  </div>

  <div class="fixed bottom-6 right-6 flex gap-3 z-40">
      <button onclick="calculer()" class="bg-indigo-600 px-8 py-4 rounded-2xl font-bold shadow-xl flex items-center gap-2">
          <i class="ph-bold ph-calculator"></i> Calculer
      </button>
      <button onclick="saveToCloud()" class="bg-emerald-600 p-4 rounded-2xl shadow-xl">
          <i class="ph-bold ph-cloud-arrow-up text-xl"></i>
      </button>
  </div>

  <div id="overlay" class="fixed inset-0 bg-black/50 z-[90] hidden-force" onclick="toggleMenu()"></div>

  <script>
    const firebaseConfig = { apiKey: "AIzaSyCdD8hr6lLhaZOwIbx688i2aGbxCyn-PTY", authDomain: "dental-guide-e0e7b.firebaseapp.com", projectId: "dental-guide-e0e7b", storageBucket: "dental-guide-e0e7b.firebasestorage.app", messagingSenderId: "653289040762", appId: "1:653289040762:web:8f416fee145b3ca7ff04c3" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(), db = firebase.firestore();

    const modules = [
        { n: "OCE", c: 5 }, { n: "ODF", c: 5 }, { n: "Parodontologie", c: 5 },
        { n: "Pathologie", c: 5 }, { n: "ProthÃ¨se", c: 5 }, { n: "Imagerie", c: 3 },
        { n: "Anat-Path", c: 1 }, { n: "AnesthÃ©sie", c: 1 }, { n: "Pharmacologie", c: 1 },
        { n: "Occlusodontie", c: 1 }, { n: "Oxyologie", c: 1 }
    ];

    let userEmail = "";

    // FORMATAGE DATE AUTO (12/02/1998)
    function formatDate(el) {
        let v = el.value.replace(/\D/g, '').slice(0, 8);
        if (v.length >= 2) v = v.slice(0, 2) + '/' + v.slice(2);
        if (v.length >= 5) v = v.slice(0, 5) + '/' + v.slice(5);
        el.value = v;
    }

    // RAISONNEMENT DE CALCUL (VOTRE CODE)
    function getModuleMoyenne(i) {
        let pts = 0, coefsCalc = 0, filled = false;
        const e1 = getV(`${i}_e1`), e2 = getV(`${i}_e2`), td = getV(`${i}_td`), tp = getV(`${i}_tp`);
        
        if ([e1, e2, td, tp].some(v => !isNaN(v))) filled = true;
        
        let emdSum = 0, emdCount = 0;
        if (!isNaN(e1)) { emdSum += e1; emdCount++; }
        if (!isNaN(e2)) { emdSum += e2; emdCount++; }
        
        if (emdCount > 0) { pts += (emdSum / emdCount); coefsCalc++; }
        if (!isNaN(td)) { pts += td * 2; coefsCalc += 2; } 
        if (!isNaN(tp)) { pts += tp * 2; coefsCalc += 2; }
        
        return filled && coefsCalc > 0 ? (pts / coefsCalc) : NaN;
    }

    function getV(id) {
        const val = document.getElementById(id).value;
        return val === "" ? NaN : parseFloat(val.replace(',', '.'));
    }

    // AUTH ET PROFIL
    function goToStep2() {
        const n = document.getElementById('id-nom').value, p = document.getElementById('id-prenom').value, d = document.getElementById('id-dob').value;
        if(!n || !p || d.length < 10) return alert("Identifiants incomplets");
        userEmail = `${n.trim()}.${p.trim()}.${d.replace(/\//g,'')}@dental.app`.toLowerCase();
        document.getElementById('authStep1').classList.add('hidden-force');
        document.getElementById('authStep2').classList.remove('hidden-force');
    }

    async function performAuth() {
        const pass = document.getElementById('auth-pass').value;
        try {
            const res = await auth.signInWithEmailAndPassword(userEmail, pass);
            setupUser(res.user.uid);
        } catch {
            const res = await auth.createUserWithEmailAndPassword(userEmail, pass);
            await db.collection("users").doc(res.user.uid).set({
                nom: document.getElementById('id-nom').value,
                prenom: document.getElementById('id-prenom').value,
                dob: document.getElementById('id-dob').value
            });
            setupUser(res.user.uid);
        }
    }

    async function updateProfile() {
        const uid = auth.currentUser.uid;
        const n = document.getElementById('edit-nom').value;
        const p = document.getElementById('edit-prenom').value;
        const d = document.getElementById('edit-dob').value;
        await db.collection("users").doc(uid).update({ nom: n, prenom: p, dob: d });
        alert("Profil mis Ã  jour !");
        closeModals();
    }

    async function changePassword() {
        const oldP = document.getElementById('old-pass').value;
        const newP = document.getElementById('new-pass').value;
        const confP = document.getElementById('confirm-pass').value;

        if(newP !== confP) return alert("Les mots de passe ne correspondent pas.");
        
        try {
            const credential = firebase.auth.EmailAuthProvider.credential(auth.currentUser.email, oldP);
            await auth.currentUser.reauthenticateWithCredential(credential);
            await auth.currentUser.updatePassword(newP);
            alert("Mot de passe changÃ© !");
            closeModals();
        } catch (e) { alert("Erreur : Ancien mot de passe incorrect."); }
    }

    // UI & LOGIQUE
    function setupUser(uid) {
        document.getElementById('authOverlay').classList.add('hidden-force');
        loadFromCloud();
    }

    function buildForm() {
        const container = document.getElementById("formContainer");
        modules.forEach((m, i) => {
            container.innerHTML += `
                <div class="glass p-6 rounded-3xl">
                    <h3 class="font-bold mb-4 text-indigo-300">${m.n} <span class="text-xs opacity-50">(Coef ${m.c})</span></h3>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" id="${i}_e1" placeholder="EMD 1" class="calc-input" oninput="updateRes(${i})">
                        <input type="number" id="${i}_e2" placeholder="EMD 2" class="calc-input" oninput="updateRes(${i})">
                        <input type="number" id="${i}_td" placeholder="TD (x2)" class="calc-input" oninput="updateRes(${i})">
                        <input type="number" id="${i}_tp" placeholder="TP (x2)" class="calc-input" oninput="updateRes(${i})">
                    </div>
                    <div class="mt-4 text-right font-black text-xl opacity-20" id="${i}_res">-</div>
                </div>`;
        });
    }

    function updateRes(i) {
        const m = getModuleMoyenne(i);
        const el = document.getElementById(`${i}_res`);
        if(!isNaN(m)) {
            el.innerText = m.toFixed(2);
            el.style.opacity = "1";
            el.style.color = m >= 10 ? "#34d399" : "#f87171";
        } else { el.innerText = "-"; el.style.opacity = "0.2"; }
    }

    function calculer() {
        let total = 0, coefs = 0;
        modules.forEach((m, i) => {
            const res = getModuleMoyenne(i);
            if(!isNaN(res)) { total += res * m.c; coefs += m.c; }
        });
        const moy = total / coefs;
        document.getElementById('resultat').innerHTML = `
            <div class="glass p-10 rounded-[40px] text-center border-t-4 ${moy >= 10 ? 'border-emerald-500' : 'border-red-500'}">
                <p class="text-sm opacity-50 mb-2 uppercase tracking-widest">Moyenne GÃ©nÃ©rale</p>
                <div class="text-7xl font-black text-white">${moy.toFixed(2)}</div>
            </div>`;
    }

    // HELPERS
    function toggleMenu() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('overlay').classList.toggle('hidden-force'); }
    function openModal(id) { document.getElementById(id).classList.remove('hidden-force'); if(id === 'profileModal') loadProfileData(); }
    function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.add('hidden-force')); }
    async function loadProfileData() {
        const doc = await db.collection("users").doc(auth.currentUser.uid).get();
        const d = doc.data();
        document.getElementById('edit-nom').value = d.nom;
        document.getElementById('edit-prenom').value = d.prenom;
        document.getElementById('edit-dob').value = d.dob;
    }

    function initTheme() {
        const t = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', t);
        document.getElementById('themeBtn').onclick = () => {
            const n = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', n);
            localStorage.setItem('theme', n);
        };
    }

    document.addEventListener('DOMContentLoaded', () => {
        buildForm();
        initTheme();
        auth.onAuthStateChanged(u => u && setupUser(u.uid));
    });

    async function saveToCloud() {
        const data = modules.map((_, i) => ({
            e1: document.getElementById(`${i}_e1`).value, e2: document.getElementById(`${i}_e2`).value,
            td: document.getElementById(`${i}_td`).value, tp: document.getElementById(`${i}_tp`).value
        }));
        await db.collection("users").doc(auth.currentUser.uid).update({ scores: data });
        alert("SauvegardÃ© !");
    }

    async function loadFromCloud() {
        const doc = await db.collection("users").doc(auth.currentUser.uid).get();
        if(doc.exists && doc.data().scores) {
            doc.data().scores.forEach((s, i) => {
                document.getElementById(`${i}_e1`).value = s.e1; document.getElementById(`${i}_e2`).value = s.e2;
                document.getElementById(`${i}_td`).value = s.td; document.getElementById(`${i}_tp`).value = s.tp;
                updateRes(i);
            });
            calculer();
        }
    }

    function logout() { auth.signOut().then(() => location.reload()); }
  </script>
</body>
</html>
